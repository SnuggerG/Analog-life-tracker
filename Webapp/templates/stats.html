<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weekly Tracker Overview</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex flex-col items-center">
  <!-- Back Button -->
  <div class="w-full max-w-4xl mb-4">
    <button onclick="window.location.href='/'" class="flex items-center text-gray-700 hover:text-gray-900">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      <span class="font-medium">Home</span>
    </button>
  </div>

  <!-- Week Navigation -->
  <div class="flex items-center mb-6 space-x-4">
    <button id="prev-week" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">&larr; Prev Week</button>
    <h2 id="week-label" class="text-xl font-semibold"></h2>
    <button id="next-week" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Next Week &rarr;</button>
  </div>

  <!-- Weekly Data Table -->
  <div class="overflow-x-auto w-full max-w-4xl bg-white rounded-lg shadow">
    <table id="stats-table" class="min-w-full divide-y divide-gray-200">
      <!-- Populated in JS -->
    </table>
  </div>

  <script>
    let currentWeek, currentYear;

    // Compute ISO week/year
    function getISOWeekYear(date) {
      const target = new Date(date.valueOf());
      const dayNr = (date.getDay() + 6) % 7;
      target.setDate(target.getDate() - dayNr + 3);
      const firstThursday = target.valueOf();
      target.setMonth(0, 1);
      if (target.getDay() !== 4) {
        target.setMonth(0, 1 + ((4 - target.getDay()) + 7) % 7);
      }
      const weekNumber = 1 + Math.ceil((firstThursday - target) / 604800000);
      return { week: weekNumber, year: target.getFullYear() };
    }

    // Render table header and body
    function renderTable(labels, trackers) {
      const tbl = document.getElementById('stats-table');
      // Build header
      let html = '<thead class="bg-gray-50"><tr>'; 
      html += '<th class="px-4 py-2 text-left">Tracker</th>';
      labels.forEach(day => {
        const d = new Date(day);
        const lbl = d.toLocaleDateString(undefined, { weekday: 'short', month: 'numeric', day: 'numeric' });
        html += `<th class="px-4 py-2 text-center">${lbl}</th>`;
      });
      html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
      // Build rows
      trackers.forEach(t => {
        html += '<tr>';
        html += `<td class="px-4 py-2 font-medium">${t.name}</td>`;
        t.hours.forEach(h => {
          html += `<td class="px-4 py-2 text-center">${h}</td>`;
        });
        html += '</tr>';
      });
      html += '</tbody>';
      tbl.innerHTML = html;
    }

    // Load data for week/year
    async function loadWeek(week, year) {
      const res = await fetch(`/api/stats?period=week&week=${week}&year=${year}`);
      const data = await res.json();
      document.getElementById('week-label').textContent = `Week ${week}, ${year}`;
      if (!data.trackers || data.trackers.length === 0) {
        document.getElementById('stats-table').innerHTML = '<tr><td class="p-4">No data for this week.</td></tr>';
        return;
      }
      renderTable(data.labels, data.trackers);
    }

    // Prev/Next handlers
    document.getElementById('prev-week').addEventListener('click', () => {
      currentWeek--;
      if (currentWeek < 1) {
        currentYear--; currentWeek = 52;
      }
      loadWeek(currentWeek, currentYear);
    });
    document.getElementById('next-week').addEventListener('click', () => {
      currentWeek++;
      if (currentWeek > 52) {
        currentYear++; currentWeek = 1;
      }
      loadWeek(currentWeek, currentYear);
    });

    // Initialize on load
    window.addEventListener('DOMContentLoaded', () => {
      const now = new Date();
      ({ week: currentWeek, year: currentYear } = getISOWeekYear(now));
      loadWeek(currentWeek, currentYear);
    });
  </script>
</body>
</html>